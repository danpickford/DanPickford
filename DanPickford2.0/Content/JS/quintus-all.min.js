/*! Quintus - v0.1.1 - 2013-02-17
* Copyright (c) 2013 Pascal Rettig; Licensed MIT, GPLv2 */
var Quintus=function e(t){var n=function(e,t,r){return n.select(e,t,r)};n.select=function(){},n.include=function(t){return n._each(n._normalizeArg(t),function(t){var r=e[t]||t;if(!n._isFunction(r))throw"Invalid Module:"+t;r(n)}),n},n._normalizeArg=function(e){return n._isString(e)&&(e=e.replace(/\s+/g,"").split(",")),n._isArray(e)||(e=[e]),e},n._extend=function(e,t){if(!t)return e;for(var n in t)e[n]=t[n];return e},n._clone=function(e){return n._extend({},e)},n._defaults=function(e,t){if(!t)return e;for(var n in t)e[n]===void 0&&(e[n]=t[n]);return e},n._has=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n._isString=function(e){return typeof e=="string"},n._isNumber=function(e){return Object.prototype.toString.call(e)==="[object Number]"},n._isFunction=function(e){return Object.prototype.toString.call(e)==="[object Function]"},n._isObject=function(e){return Object.prototype.toString.call(e)==="[object Object]"},n._isArray=function(e){return Object.prototype.toString.call(e)==="[object Array]"},n._isUndefined=function(e){return e===void 0},n._popProperty=function(e,t){var n=e[t];return delete e[t],n},n._each=function(e,t,n){if(e==null)return;if(e.forEach)e.forEach(t,n);else if(e.length===+e.length)for(var r=0,i=e.length;r<i;r++)t.call(n,e[r],r,e);else for(var s in e)t.call(n,e[s],s,e)},n._invoke=function(e,t,n,r){if(e==null)return;for(var i=0,s=e.length;i<s;i++)e[i][t](n,r)},n._detect=function(e,t,n,r,i){var s;if(e==null)return;if(e.length===+e.length){for(var o=0,u=e.length;o<u;o++){s=t.call(n,e[o],o,r,i);if(s)return s}return!1}for(var a in e){s=t.call(n,e[a],a,r,i);if(s)return s}return!1},n._map=function(e,t,r){var i=[];return e==null?i:e.map?e.map(t,r):(n._each(e,function(e,n,s){i[i.length]=t.call(r,e,n,s)}),e.length===+e.length&&(i.length=e.length),i)},n._uniq=function(e){e=e.slice().sort();var t=[],n=null;for(var r=0;r<e.length;r++)e[r]!==void 0&&n!==e[r]&&t.push(e[r]),n=e[r];return t},n._shuffle=function(e){var t=[],r;return n._each(e,function(e,n,i){r=Math.floor(Math.random()*(n+1)),t[n]=t[r],t[r]=e}),t},n._keys=Object.keys||function(e){if(n._isObject(e))throw new TypeError("Invalid object");var t=[];for(var r in e)n._has(e,r)&&(t[t.length]=r);return t},n._range=function(e,t,n){n=arguments[2]||1;var r=Math.max(Math.ceil((t-e)/n),0),i=0,s=new Array(r);while(i<r)s[i++]=e,e+=n;return s};var r=0;return n._uniqueId=function(){return r++},n.options={imagePath:"images/",audioPath:"audio/",dataPath:"data/",audioSupported:["mp3","ogg"],sound:!0,frameTimeLimit:100},t&&n._extend(n.options,t),n.gameLoop=function(e){return n.lastGameLoopFrame=(new Date).getTime(),n.loop=!0,n._loopFrame=0,n.gameLoopCallbackWrapper=function(){var t=(new Date).getTime();n._loopFrame++,n.loop=window.requestAnimationFrame(n.gameLoopCallbackWrapper);var r=t-n.lastGameLoopFrame;r>n.options.frameTimeLimit&&(r=n.options.frameTimeLimit),e.apply(n,[r/1e3]),n.lastGameLoopFrame=t},window.requestAnimationFrame(n.gameLoopCallbackWrapper),n},n.pauseGame=function(){n.loop&&window.cancelAnimationFrame(n.loop),n.loop=null},n.unpauseGame=function(){n.loop||(n.lastGameLoopFrame=(new Date).getTime(),n.loop=window.requestAnimationFrame(n.gameLoopCallbackWrapper))},function(){var e=!1,t=/xyz/.test(function(){var e})?/\b_super\b/:/.*/;n.Class=function(){},n.Class.prototype.isA=function(e){return this.className===e},n.Class.extend=function(r,i,s){function f(e,t){return function(){var n=this._super;this._super=o[e];var r=t.apply(this,arguments);return this._super=n,r}}function c(){!e&&this.init&&this.init.apply(this,arguments)}n._isString(r)||(s=i,i=r,r=null);var o=this.prototype,u=this;e=!0;var a=new u;e=!1;for(var l in i)a[l]=typeof i[l]=="function"&&typeof o[l]=="function"&&t.test(i[l])?f(l,i[l]):i[l];return c.prototype=a,c.prototype.constructor=c,c.extend=n.Class.extend,s&&n._extend(c,s),r&&(n[r]=c,c.prototype.className=r,c.className=r),c}}(),n.Class.extend("Evented",{on:function(e,t,r){if(n._isArray(e)||e.indexOf(",")!==-1){e=n._normalizeArg(e);for(var i=0;i<e.length;i++)this.on(e[i],t,r);return}r||(r=t,t=null),r||(r=e),n._isString(r)&&(r=(t||this)[r]),this.listeners=this.listeners||{},this.listeners[e]=this.listeners[e]||[],this.listeners[e].push([t||this,r]),t&&(t.binds||(t.binds=[]),t.binds.push([this,e,r]))},trigger:function(e,t){if(this.listeners&&this.listeners[e])for(var n=0,r=this.listeners[e].length;n<r;n++){var i=this.listeners[e][n];i[1].call(i[0],t)}},off:function(e,t,r){if(!t)this.listeners[e]&&delete this.listeners[e];else{n._isString(r)&&t[r]&&(r=t[r]);var i=this.listeners&&this.listeners[e];if(i)for(var s=i.length-1;s>=0;s--)i[s][0]===t&&(!r||r===i[s][1])&&this.listeners[e].splice(s,1)}},debind:function(){if(this.binds)for(var e=0,t=this.binds.length;e<t;e++){var n=this.binds[e],r=n[0],i=n[1];r.off(i,this)}}}),n.components={},n.Evented.extend("Component",{init:function(e){this.entity=e,this.extend&&n._extend(e,this.extend),e[this.name]=this,e.activeComponents.push(this.componentName),e.stage&&e.stage.addToList&&e.stage.addToList(this.componentName,e),this.added&&this.added()},destroy:function(){if(this.extend){var e=n._keys(this.extend);for(var t=0,r=e.length;t<r;t++)delete this.entity[e[t]]}delete this.entity[this.name];var i=this.entity.activeComponents.indexOf(this.componentName);i!==-1&&(this.entity.activeComponents.splice(i,1),this.entity.stage&&this.entity.stage.addToList&&this.entity.stage.addToLists(this.componentName,this.entity)),this.debind(),this.destroyed&&this.destroyed()}}),n.Evented.extend("GameObject",{has:function(e){return this[e]?!0:!1},add:function(e){e=n._normalizeArg(e),this.activeComponents||(this.activeComponents=[]);for(var t=0,r=e.length;t<r;t++){var i=e[t],s=n.components[i];if(!this.has(i)&&s){var o=new s(this);this.trigger("addComponent",o)}}return this},del:function(e){e=n._normalizeArg(e);for(var t=0,r=e.length;t<r;t++){var i=e[t];i&&this.has(i)&&(this.trigger("delComponent",this[i]),this[i].destroy())}return this},destroy:function(){if(this.isDestroyed)return;this.trigger("destroyed"),this.debind(),this.stage&&this.stage.remove&&this.stage.remove(this),this.isDestroyed=!0,this.destroyed&&this.destroyed()}}),n.component=function(e,t){return t?(t.name=e,t.componentName="."+e,n.components[e]=n.Component.extend(e+"Component",t)):n.components[e]},n.GameObject.extend("GameState",{init:function(e){this.p=n._extend({},e),this.listeners={}},reset:function(e){this.init(e),this.trigger("reset")},_triggerProperty:function(e,t){this.p[t]!==e&&(this.p[t]=e,this.trigger("change."+t,e))},set:function(e,t){n._isObject(e)?n._each(e,this._triggerProperty,this):this._triggerProperty(t,e),this.trigger("change")},inc:function(e,t){this.set(e,this.get(e)+t)},dec:function(e,t){this.set(e,this.get(e)-t)},get:function(e){return this.p[e]}}),n.state=new n.GameState,n.reset=function(){n.state.reset()},n.touchDevice="ontouchstart"in document,n.setup=function(e,t){n._isObject(e)&&(t=e,e=null),t=t||{},e=e||"quintus",n._isString(e)?n.el=document.getElementById(e):n.el=e,n.el||(n.el=document.createElement("canvas"),n.el.width=t.width||320,n.el.height=t.height||420,n.el.id=e,document.body.appendChild(n.el));var r=parseInt(n.el.width,10),i=parseInt(n.el.height,10),s=t.maxWidth||5e3,o=t.maxHeight||5e3,u=t.resampleWidth,a=t.resampleHeight,f=t.upsampleWidth,l=t.upsampleHeight;t.maximize===!0||n.touchDevice&&t.maximize==="touch"?(document.body.style.padding=0,document.body.style.margin=0,r=Math.min(window.innerWidth,s),i=Math.min(window.innerHeight-5,o),n.touchDevice&&(n.el.style.height=i*2+"px",window.scrollTo(0,1),r=Math.min(window.innerWidth,s),i=Math.min(window.innerHeight,o))):n.touchDevice&&window.scrollTo(0,1),f&&r<=f||l&&i<=l?(n.el.style.height=i+"px",n.el.style.width=r+"px",n.el.width=r*2,n.el.height=i*2):(u&&r>u||a&&i>a)&&n.touchDevice?(n.el.style.height=i+"px",n.el.style.width=r+"px",n.el.width=r/2,n.el.height=i/2):(n.el.style.height=i+"px",n.el.style.width=r+"px",n.el.width=r,n.el.height=i);var c=n.el.parentNode;return c&&(n.wrapper=document.createElement("div"),n.wrapper.id=e+"_container",n.wrapper.style.width=r+"px",n.wrapper.style.margin="0 auto",n.wrapper.style.position="relative",c.insertBefore(n.wrapper,n.el),n.wrapper.appendChild(n.el)),n.el.style.position="relative",n.ctx=n.el.getContext&&n.el.getContext("2d"),n.width=parseInt(n.el.width,10),n.height=parseInt(n.el.height,10),n.cssWidth=r,n.cssHeight=i,window.addEventListener("orientationchange",function(){setTimeout(function(){window.scrollTo(0,1)},0)}),n},n.clear=function(){n.clearColor?(n.ctx.globalAlpha=1,n.ctx.fillStyle=n.clearColor,n.ctx.fillRect(0,0,n.width,n.height)):n.ctx.clearRect(0,0,n.width,n.height)},n.imageData=function(e){var t=document.createElement("canvas");t.width=e.width,t.height=e.height;var n=t.getContext("2d");return n.drawImage(e,0,0),n.getImageData(0,0,e.width,e.height)},n.assetTypes={png:"Image",jpg:"Image",gif:"Image",jpeg:"Image",ogg:"Audio",wav:"Audio",m4a:"Audio",mp3:"Audio"},n.assetType=function(e){var t=e.split("."),r=t[t.length-1].toLowerCase(),i=n.assetTypes[r];return i==="Audio"&&n.audio&&n.audio.type==="WebAudio"&&(i="WebAudio"),i||"Other"},n.assetUrl=function(e,t){return/^https?:\/\//.test(t)||t[0]==="/"?t:e+t},n.loadAssetImage=function(e,t,r,i){var s=new Image;s.onload=function(){r(e,s)},s.onerror=i,s.src=n.assetUrl(n.options.imagePath,t)},n.audioMimeTypes={mp3:"audio/mpeg",ogg:'audio/ogg; codecs="vorbis"',m4a:"audio/m4a",wav:"audio/wav"},n._audioAssetExtension=function(){if(n._audioAssetPreferredExtension)return n._audioAssetPreferredExtension;var e=new Audio;return n._audioAssetPreferredExtension=n._detect(n.options.audioSupported,function(t){return e.canPlayType(n.audioMimeTypes[t])?t:null})},n.loadAssetAudio=function(e,t,r,i){if(!document.createElement("audio").play||!n.options.sound){r(e,null);return}var s=n._removeExtension(t),o=n._audioAssetExtension(),u=null,a=new Audio;if(!o){r(e,null);return}a.addEventListener("error",i),n.touchDevice||a.addEventListener("canplaythrough",function(){r(e,a)}),a.src=n.assetUrl(n.options.audioPath,s+"."+o),a.load(),n.touchDevice&&r(e,a)},n.loadAssetWebAudio=function(e,t,r,i){var s=new XMLHttpRequest,o=n._removeExtension(t),u=n._audioAssetExtension();s.open("GET",n.assetUrl(n.options.audioPath,o+"."+u),!0),s.responseType="arraybuffer",s.onload=function(){var t=s.response;n.audioContext.decodeAudioData(s.response,function(t){r(e,t)},i)},s.send()},n.loadAssetOther=function(e,t,r,i){var s=new XMLHttpRequest,o=t.split("."),u=o[o.length-1].toLowerCase();s.onreadystatechange=function(){s.readyState===4&&(s.status===200?u==="json"?r(e,JSON.parse(s.responseText)):r(e,s.responseText):i())},s.open("GET",n.options.dataPath+t,!0),s.send(null)},n._removeExtension=function(e){return e.replace(/\.(\w{3,4})$/,"")},n.assets={},n.asset=function(e){return n.assets[e]},n.load=function(e,t,r){var i={};r||(r={});var s=r.progressCallback,o=!1,u=function(e){o=!0,(r.errorCallback||function(e){throw"Error Loading: "+e})(e)};n._isString(e)&&(e=n._normalizeArg(e)),n._isArray(e)?n._each(e,function(e){n._isObject(e)?n._extend(i,e):i[e]=e}):i=e;var a=n._keys(i).length,f=a,l=function(e,r,i){if(o)return;if(!n.assets[e]||i)n.assets[e]=r,f--,s&&s(a-f,a);f===0&&t&&t.apply(n)};n._each(i,function(e,t){var r=n.assetType(e);n.assets[t]?l(t,n.assets[t],!0):n["loadAsset"+r](t,e,l,function(){u(e)})})},n.preloads=[],n.preload=function(e,t){n._isFunction(e)?(n.load(n._uniq(n.preloads),e,t),n.preloads=[]):n.preloads=n.preloads.concat(e)},n.matrices2d=[],n.matrix2d=function(){return n.matrices2d.length>0?n.matrices2d.pop().identity():new n.Matrix2D},n.Matrix2D=n.Class.extend({init:function(e){e?(this.m=[],this.clone(e)):this.m=[1,0,0,0,1,0]},identity:function(){var e=this.m;return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,this},clone:function(e){var t=this.m,n=e.m;return t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t[4]=n[4],t[5]=n[5],this},multiply:function(e){var t=this.m,n=e.m,r=t[0]*n[0]+t[1]*n[3],i=t[0]*n[1]+t[1]*n[4],s=t[0]*n[2]+t[1]*n[5]+t[2],o=t[3]*n[0]+t[4]*n[3],u=t[3]*n[1]+t[4]*n[4],a=t[3]*n[2]+t[4]*n[5]+t[5];return t[0]=r,t[1]=i,t[2]=s,t[3]=o,t[4]=u,t[5]=a,this},rotate:function(e){if(e===0)return this;var t=Math.cos(e),n=Math.sin(e),r=this.m,i=r[0]*t+r[1]*n,s=r[0]*-n+r[1]*t,o=r[3]*t+r[4]*n,u=r[3]*-n+r[4]*t;return r[0]=i,r[1]=s,r[3]=o,r[4]=u,this},rotateDeg:function(e){return e===0?this:this.rotate(Math.PI*e/180)},scale:function(e,t){var n=this.m;return t===void 0&&(t=e),n[0]*=e,n[1]*=t,n[3]*=e,n[4]*=t,this},translate:function(e,t){var n=this.m;return n[2]+=n[0]*e+n[1]*t,n[5]+=n[3]*e+n[4]*t,this},transform:function(e,t){return[e*this.m[0]+t*this.m[1]+this.m[2],e*this.m[3]+t*this.m[4]+this.m[5]]},transformPt:function(e){var t=e.x,n=e.y;return e.x=t*this.m[0]+n*this.m[1]+this.m[2],e.y=t*this.m[3]+n*this.m[4]+this.m[5],e},transformArr:function(e,t){var n=e[0],r=e[1];return t[0]=n*this.m[0]+r*this.m[1]+this.m[2],t[1]=n*this.m[3]+r*this.m[4]+this.m[5],t},transformX:function(e,t){return e*this.m[0]+t*this.m[1]+this.m[2]},transformY:function(e,t){return e*this.m[3]+t*this.m[4]+this.m[5]},release:function(){return n.matrices2d.push(this),null},setContextTransform:function(e){var t=this.m;e.transform(t[0],t[3],t[1],t[4],t[2],t[5])}}),n};(function(){var e=0,t=["ms","moz","webkit","o"];for(var n=0;n<t.length&&!window.requestAnimationFrame;++n)window.requestAnimationFrame=window[t[n]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[n]+"CancelAnimationFrame"]||window[t[n]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(t,n){var r=(new Date).getTime(),i=Math.max(0,16-(r-e)),s=window.setTimeout(function(){t(r+i)},i);return e=r+i,s}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})})(),Quintus.Audio=function(e){e.audio={channels:[],channelMax:e.options.channelMax||10,active:{},play:function(){}},e.hasWebAudio=typeof AudioContext!="undefined"||typeof webkitAudioContext!="undefined",e.hasWebAudio&&(typeof AudioContext!="undefined"?e.audioContext=new AudioContext:e.audioContext=new window.webkitAudioContext),e.enableSound=function(){var t="ontouchstart"in window;return e.hasWebAudio?e.audio.enableWebAudioSound():e.audio.enableHTML5Sound(),e},e.audio.enableWebAudioSound=function(){e.audio.type="WebAudio",e.audio.soundID=0,e.audio.playingSounds={},e.audio.removeSound=function(t){delete e.audio.playingSounds[t]},e.audio.play=function(t,n){var r=(new Date).getTime();if(e.audio.active[t]&&e.audio.active[t]>r)return;n&&n.debounce?e.audio.active[t]=r+n.debounce:delete e.audio.active[t];var i=e.audio.soundID++,s=e.audioContext.createBufferSource();s.buffer=e.asset(t),s.connect(e.audioContext.destination),n&&n.loop?s.loop=!0:setTimeout(function(){e.audio.removeSound(i)},s.buffer.duration*1e3),s.assetName=t,s.start?s.start(0):s.noteOn(0),e.audio.playingSounds[i]=s},e.audio.stop=function(t){for(var n in e.audio.playingSounds){var r=e.audio.playingSounds[n];if(!t||t===r.assetName)r.stop?r.stop(0):r.noteOff(0)}}},e.audio.enableHTML5Sound=function(){e.audio.type="HTML5";for(var t=0;t<e.audio.channelMax;t++)e.audio.channels[t]={},e.audio.channels[t].channel=new Audio,e.audio.channels[t].finished=-1;e.audio.play=function(t,n){var r=(new Date).getTime();if(e.audio.active[t]&&e.audio.active[t]>r)return;n&&n.debounce?e.audio.active[t]=r+n.debounce:delete e.audio.active[t];for(var i=0;i<e.audio.channels.length;i++)if(!e.audio.channels[i].loop&&e.audio.channels[i].finished<r){e.audio.channels[i].channel.src=e.asset(t).src,n&&n.loop?(e.audio.channels[i].loop=!0,e.audio.channels[i].channel.loop=!0):e.audio.channels[i].finished=r+e.asset(t).duration*1e3,e.audio.channels[i].channel.load(),e.audio.channels[i].channel.play();break}},e.audio.stop=function(t){var n=t?e.asset(t).src:null,r=(new Date).getTime();for(var i=0;i<e.audio.channels.length;i++)(!n||e.audio.channels[i].channel.src===n)&&(e.audio.channels[i].loop||e.audio.channels[i].finished>=r)&&(e.audio.channels[i].channel.pause(),e.audio.channels[i].loop=!1)}}},Quintus.UI=function(e){if(e._isUndefined(Quintus.Touch))throw"Quintus.UI requires Quintus.Touch Module";e.UI={},e.UI.roundRect=function(e,t){e.beginPath(),e.moveTo(-t.cx+t.radius,-t.cy),e.lineTo(-t.cx+t.w-t.radius,-t.cy),e.quadraticCurveTo(-t.cx+t.w,-t.cy,-t.cx+t.w,-t.cy+t.radius),e.lineTo(-t.cx+t.w,-t.cy+t.h-t.radius),e.quadraticCurveTo(-t.cx+t.w,-t.cy+t.h,-t.cx+t.w-t.radius,-t.cy+t.h),e.lineTo(-t.cx+t.radius,-t.cy+t.h),e.quadraticCurveTo(-t.cx,-t.cy+t.h,-t.cx,-t.cy+t.h-t.radius),e.lineTo(-t.cx,-t.cy+t.radius),e.quadraticCurveTo(-t.cx,-t.cy,-t.cx+t.radius,-t.cy),e.closePath()},e.UI.Container=e.Sprite.extend("UI.Container",{init:function(t,n){var r=e._clone(t||{}),i;t&&e._isString(t.w)&&(i=t.w.match(/^[0-9]+%$/))&&(r.w=parseInt(t.w,10)*e.width/100,r.x=e.width/2-r.w/2),t&&e._isString(t.h)&&(i=t.h.match(/^[0-9]+%$/))&&(r.h=parseInt(t.h,10)*e.height/100,r.y=e.height/2-r.h/2),this._super(r,{opacity:1,hidden:!1,fill:null,highlight:null,radius:5,stroke:"#000",border:!1,shadow:!1,shadowColor:!1,type:e.SPRITE_NONE})},insert:function(e){return this.stage.insert(e,this),e},fit:function(e,t){if(this.children.length===0)return;e===void 0&&(e=0),t===void 0&&(t=e);var n=Infinity,r=Infinity,i=-Infinity,s=-Infinity;for(var o=0;o<this.children.length;o++){var u=this.children[o],a=u.p.x-u.p.cx,f=u.p.y-u.p.cy,l=u.p.x-u.p.cx+u.p.w,c=u.p.y-u.p.cy+u.p.h;a<n&&(n=a),f<r&&(r=f),l>i&&(i=l),c>s&&(s=c)}this.p.cx=-n+t,this.p.cy=-r+e,this.p.w=i-n+t*2,this.p.h=s-r+e*2},addShadow:function(t){if(this.p.shadow){var n=e._isNumber(this.p.shadow)?this.p.shadow:5;t.shadowOffsetX=n,t.shadowOffsetY=n,t.shadowColor=this.p.shadowColor||"rgba(0,0,50,0.1)"}},clearShadow:function(e){e.shadowColor="transparent"},drawRadius:function(t){e.UI.roundRect(t,this.p),this.addShadow(t),t.fill(),this.p.border&&(this.clearShadow(t),t.lineWidth=this.p.border,t.stroke())},drawSquare:function(e){this.addShadow(e),this.p.fill&&e.fillRect(-this.p.cx,-this.p.cy,this.p.w,this.p.h),this.p.border&&(this.clearShadow(e),e.lineWidth=this.p.border,e.strokeRect(-this.p.cx,-this.p.cy,this.p.w,this.p.h))},draw:function(e){if(this.p.hidden)return!1;if(!this.p.border&&!this.p.fill)return;e.globalAlpha=this.p.opacity,this.p.frame===1&&this.p.highlight?e.fillStyle=this.p.highlight:e.fillStyle=this.p.fill,e.strokeStyle=this.p.stroke,this.p.radius>0?this.drawRadius(e):this.drawSquare(e)}}),e.UI.Text=e.Sprite.extend("UI.Text",{init:function(t,n){this._super(e._defaults(t||{},n),{type:e.SPRITE_UI,size:24}),this.p.label&&this.calcSize()},calcSize:function(){this.setFont(e.ctx),this.splitLabel=this.p.label.split("\n");var t="";for(var n=0;n<this.splitLabel.length;n++)this.splitLabel[n].length>t.length&&(t=this.splitLabel[n]);var r=e.ctx.measureText(t);this.p.h=(this.p.size||24)*this.splitLabel.length*1.2,this.p.w=r.width,this.p.cx=this.p.w/2,this.p.cy=this.p.h/2},prerender:function(){if(this.p.oldLabel===this.p.label)return;this.p.oldLabel=this.p.label,this.calcSize(),this.el.width=this.p.w,this.el.height=this.p.h*4,this.ctx.clearRect(0,0,this.p.w,this.p.h),this.ctx.fillStyle="#FF0",this.ctx.fillRect(0,0,this.p.w,this.p.h/2),this.setFont(this.ctx),this.ctx.fillText(this.p.label,0,0)},draw:function(e){if(this.p.opacity===0)return;this.p.oldLabel!==this.p.label&&this.calcSize(),this.setFont(e),this.p.opacity!==void 0&&(e.globalAlpha=this.p.opacity);for(var t=0;t<this.splitLabel.length;t++)this.p.align==="center"?e.fillText(this.splitLabel[t],0,-this.p.cy+t*this.p.size*1.2):this.p.align==="right"?e.fillText(this.splitLabel[t],this.p.cx,-this.p.cy+t*this.p.size*1.2):e.fillText(this.splitLabel[t],-this.p.cx,-this.p.cy+t*this.p.size*1.2)},asset:function(){return this.el},setFont:function(e){e.textBaseline="top",e.font=this.font(),e.fillStyle=this.p.color||"black",e.textAlign=this.p.align||"left"},font:function(){return this.fontString?this.fontString:(this.fontString=(this.p.weight||"800")+" "+(this.p.size||24)+"px "+(this.p.family||"Arial"),this.fontString)}}),e.UI.Button=e.UI.Container.extend("UI.Button",{init:function(t,n){this._super(e._defaults(t,{type:e.SPRITE_UI|e.SPRITE_DEFAULT}));if(this.p.label&&(!this.p.w||!this.p.h)){e.ctx.save(),this.setFont(e.ctx);var r=e.ctx.measureText(this.p.label);e.ctx.restore(),this.p.h||(this.p.h=44),this.p.w||(this.p.w=r.width+20)}isNaN(this.p.cx)&&(this.p.cx=this.p.w/2),isNaN(this.p.cy)&&(this.p.cy=this.p.h/2),this.callback=n,this.on("touch",this,"highlight"),this.on("touchEnd",this,"push")},highlight:function(){if(!this.sheet()||this.sheet().frames>1)this.p.frame=1},push:function(){this.p.frame=0,this.callback&&this.callback(),this.trigger("click")},draw:function(t){this._super(t),(this.p.asset||this.p.sheet)&&e.Sprite.prototype.draw.call(this,t),this.p.label&&(t.save(),this.setFont(t),t.fillText(this.p.label,0,0),t.restore())},setFont:function(e){e.textBaseline="middle",e.font=this.p.font||"400 24px arial",e.fillStyle=this.p.fontColor||"black",e.textAlign="center"}}),e.UI.IFrame=e.Sprite.extend("UI.IFrame",{init:function(t){this._super(t,{opacity:1,type:e.SPRITE_UI|e.SPRITE_DEFAULT}),e.wrapper.style.overflow="hidden",this.iframe=document.createElement("IFRAME"),this.iframe.setAttribute("src",this.p.url),this.iframe.style.position="absolute",this.iframe.style.zIndex=500,this.iframe.setAttribute("width",this.p.w),this.iframe.setAttribute("height",this.p.h),this.iframe.setAttribute("frameborder",0),this.p.background&&(this.iframe.style.backgroundColor=this.p.background),e.wrapper.appendChild(this.iframe),this.on("inserted",function(e){this.positionIFrame(),e.on("destroyed",this,"remove")})},positionIFrame:function(){var e=this.p.x,t=this.p.y;this.stage.viewport&&(e-=this.stage.viewport.x,t-=this.stage.viewport.y);if(this.oldX!==e||this.oldY!==t||this.oldOpacity!==this.p.opacity)this.iframe.style.top=t-this.p.cy+"px",this.iframe.style.left=e-this.p.cx+"px",this.iframe.style.opacity=this.p.opacity,this.oldX=e,this.oldY=t,this.oldOpacity=this.p.opacity},step:function(e){this._super(e),this.positionIFrame()},remove:function(){this.iframe&&(e.wrapper.removeChild(this.iframe),this.iframe=null)}}),e.UI.HTMLElement=e.Sprite.extend("UI.HTMLElement",{init:function(t){this._super(t,{opacity:1,type:e.SPRITE_UI}),e.wrapper.style.overflow="hidden",this.el=document.createElement("div"),this.el.innerHTML=this.p.html,e.wrapper.appendChild(this.el),this.on("inserted",function(e){this.position(),e.on("destroyed",this,"remove"),e.on("clear",this,"remove")})},position:function(){},step:function(e){this._super(e),this.position()},remove:function(){this.el&&(e.wrapper.removeChild(this.el),this.el=null)}}),e.UI.VerticalLayout=e.Sprite.extend("UI.VerticalLayout",{init:function(e){this.children=[],this._super(e,{type:0})},insert:function(e){return this.stage.insert(e,this),this.relayout(),e},relayout:function(){var e=0;for(var t=0;t<this.children.length;t++)e+=this.children[t].p.h||0;var n=this.p.h-e}})},Quintus.Anim=function(e){e._animations={},e.animations=function(t,n){e._animations[t]||(e._animations[t]={}),e._extend(e._animations[t],n)},e.animation=function(t,n){return e._animations[t]&&e._animations[t][n]},e.component("animation",{added:function(){var e=this.entity.p;e.animation=null,e.animationPriority=-1,e.animationFrame=0,e.animationTime=0,this.entity.on("step",this,"step")},extend:{play:function(e,t){this.animation.play(e,t)}},step:function(t){var n=this.entity,r=n.p;if(r.animation){var i=e.animation(r.sprite,r.animation),s=i.rate||r.rate,o=0;r.animationTime+=t,r.animationChanged?r.animationChanged=!1:(r.animationTime+=t,r.animationTime>s&&(o=Math.floor(r.animationTime/s),r.animationTime-=o*s,r.animationFrame+=o));if(o>0){if(r.animationFrame>=i.frames.length){if(i.loop===!1||i.next){r.animationFrame=i.frames.length-1,n.trigger("animEnd"),n.trigger("animEnd."+r.animation),r.animation=null,r.animationPriority=-1,i.trigger&&n.trigger(i.trigger,i.triggerData),i.next&&this.play(i.next,i.nextPriority);return}n.trigger("animLoop"),n.trigger("animLoop."+r.animation),r.animationFrame=r.animationFrame%i.frames.length}n.trigger("animFrame")}r.sheet=i.sheet||r.sheet,r.frame=i.frames[r.animationFrame]}},play:function(e,t){var n=this.entity,r=n.p;t=t||0,e!==r.animation&&t>=r.animationPriority&&(r.animation=e,r.animationChanged=!0,r.animationTime=0,r.animationFrame=0,r.animationPriority=t,n.trigger("anim"),n.trigger("anim."+r.animation))}}),e.Sprite.extend("Repeater",{init:function(t){this._super(e._defaults(t,{speedX:1,speedY:1,repeatY:!0,repeatX:!0})),this.p.repeatW=this.p.repeatW||this.p.w,this.p.repeatH=this.p.repeatH||this.p.h},draw:function(t){var n=this.p,r=this.asset(),i=this.sheet(),s=this.stage.viewport?this.stage.viewport.scale:1,o=this.stage.viewport?this.stage.viewport.x:0,u=this.stage.viewport?this.stage.viewport.y:0,a=n.x+o*this.p.speedX,f=n.y+u*this.p.speedY,l,c,h;n.repeatX?(l=Math.floor(-a%n.repeatW),l>0&&(l-=n.repeatW)):l=n.x-o,n.repeatY?(c=Math.floor(-f%n.repeatH),c>0&&(c-=n.repeatH)):c=n.y-u,h=l;while(c<e.height/s){l=h;while(l<e.width/s){i?i.draw(t,Math.floor(l+o),Math.floor(c+u),n.frame):t.drawImage(r,Math.floor(l+o),Math.floor(c+u)),l+=n.repeatW;if(!n.repeatX)break}c+=n.repeatH;if(!n.repeatY)break}}}),e.Tween=e.Class.extend({init:function(t,n,r,i,s){e._isObject(i)&&(s=i,i=e.Easing.Linear),e._isObject(r)&&(s=r,r=1),this.entity=t,this.duration=r||1,this.time=0,this.options=s||{},this.delay=this.options.delay||0,this.easing=i||this.options.easing||e.Easing.Linear,this.startFrame=e._loopFrame+1,this.properties=n,this.start={},this.diff={}},step:function(t){var n;if(this.startFrame>e._loopFrame)return!0;if(this.delay>=t)return this.delay-=t,!0;this.delay>0&&(t-=this.delay,this.delay=0);if(this.time===0){var r=this.entity,i=this.properties;this.p=r instanceof e.Stage?r.viewport:r.p;for(n in i)this.start[n]=this.p[n],e._isUndefined(this.start[n])||(this.diff[n]=i[n]-this.start[n])}this.time+=t;var s=Math.min(1,this.time/this.duration),o=this.easing(s);for(n in this.start)e._isUndefined(this.p[n])||(this.p[n]=this.start[n]+this.diff[n]*o);return s>=1&&this.options.callback&&this.options.callback.apply(this.entity),s<1}}),e.Easing={Linear:function(e){return e},Quadratic:{In:function(e){return e*e},Out:function(e){return e*(2-e)},InOut:function(e){return(e*=2)<1?.5*e*e:-0.5*(--e*(e-2)-1)}}},e.component("tween",{added:function(){this._tweens=[],this.entity.on("step",this,"step")},extend:{animate:function(t,n,r,i){return this.tween._tweens.push(new e.Tween(this,t,n,r,i)),this},chain:function(t,n,r,i){e._isObject(r)&&(i=r,r=e.Easing.Linear);var s=this.tween._tweens.length;if(s>0){var o=this.tween._tweens[s-1];i=i||{},i.delay=o.duration-o.time+o.delay}return this.animate(t,n,r,i),this},stop:function(){return this.tween._tweens.length=0,this}},step:function(e){for(var t=0;t<this._tweens.length;t++)this._tweens[t].step(e)||(this._tweens.splice(t,1),t--)}})},Quintus.Input=function(e){var t={LEFT:37,RIGHT:39,SPACE:32,UP:38,DOWN:40,Z:90,X:88},n={LEFT:"left",RIGHT:"right",UP:"up",DOWN:"down",SPACE:"fire",Z:"fire",X:"action"},r=[["left","<"],["right",">"],[],["action","b"],["fire","a"]],i=["up","right","down","left"];e.inputs={},e.joypad={};var s="ontouchstart"in window;e.canvasToStageX=function(t,n){return t=t/e.cssWidth*e.width,n.viewport&&(t/=n.viewport.scale,t+=n.viewport.x),t},e.canvasToStageY=function(t,n){return t=t/e.cssWidth*e.width,n.viewport&&(t/=n.viewport.scale,t+=n.viewport.y),t},e.InputSystem=e.Evented.extend({keys:{},keypad:{},keyboardEnabled:!1,touchEnabled:!1,joypadEnabled:!1,bindKey:function(n,r){e.input.keys[t[n]||n]=r},keyboardControls:function(t){t=t||n,e._each(t,function(e,t){this.bindKey(t,e)},e.input),this.enableKeyboard()},enableKeyboard:function(){if(this.keyboardEnabled)return!1;e.el.tabIndex=0,e.el.style.outline=0,e.el.addEventListener("keydown",function(t){if(e.input.keys[t.keyCode]){var n=e.input.keys[t.keyCode];e.inputs[n]=!0,e.input.trigger(n),e.input.trigger("keydown",t.keyCode)}t.preventDefault()},!1),e.el.addEventListener("keyup",function(t){if(e.input.keys[t.keyCode]){var n=e.input.keys[t.keyCode];e.inputs[n]=!1,e.input.trigger(n+"Up"),e.input.trigger("keyup",t.keyCode)}t.preventDefault()},!1),this.keyboardEnabled=!0},_containerOffset:function(){e.input.offsetX=0,e.input.offsetY=0;var t=e.el;do e.input.offsetX+=t.offsetLeft,e.input.offsetY+=t.offsetTop;while(t=t.offsetParent)},touchLocation:function(t){var n=e.el,r=t.offsetX,i=t.offsetY,s,o;if(e._isUndefined(r)||e._isUndefined(i))r=t.layerX,i=t.layerY;if(e._isUndefined(r)||e._isUndefined(i))e.input.offsetX===void 0&&e.input._containerOffset(),r=t.pageX-e.input.offsetX,i=t.pageY-e.input.offsetY;return s=e.width*r/e.cssWidth,o=e.height*i/e.cssHeight,{x:s,y:o}},touchControls:function(t){function n(n){var r=e.input.touchLocation(n);for(var i=0,s=t.controls.length;i<s;i++)if(r.x<t.unit*(i+1))return t.controls[i][0]}function i(r){var i={},s,o,u,a,f;for(s=0,o=t.controls.length;s<o;s++)f=t.controls[s][0],e.inputs[f]&&(i[f]=!0),e.inputs[f]=!1;var l=r.touches?r.touches:[r];for(s=0,o=l.length;s<o;s++)u=l[s],a=n(u),a&&(e.inputs[a]=!0,i[a]?delete i[a]:e.input.trigger(a));for(f in i)e.input.trigger(f+"Up");return null}if(this.touchEnabled)return!1;if(!s)return!1;e.input.keypad=t=e._extend({left:0,gutter:10,controls:r,width:e.width,bottom:e.height},t),t.unit=t.width/t.controls.length,t.size=t.unit-2*t.gutter,this.touchDispatchHandler=function(e){i(e),e.preventDefault()},e._each(["touchstart","touchend","touchmove","touchcancel"],function(t){e.el.addEventListener(t,this.touchDispatchHandler)},this),this.touchEnabled=!0},disableTouchControls:function(){e._each(["touchstart","touchend","touchmove","touchcancel"],function(t){e.el.removeEventListener(t,this.touchDispatchHandler)},this),e.el.removeEventListener("touchstart",this.joypadStart),e.el.removeEventListener("touchmove",this.joypadMove),e.el.removeEventListener("touchend",this.joypadEnd),e.el.removeEventListener("touchcancel",this.joypadEnd),this.touchEnabled=!1},joypadControls:function(t){if(this.joypadEnabled)return!1;if(!s)return!1;var n=e.joypad=e._defaults(t||{},{size:50,trigger:20,center:25,color:"#CCC",background:"#000",alpha:.5,zone:e.width/2,joypadTouch:null,inputs:i,triggers:[]});this.joypadStart=function(t){if(n.joypadTouch===null){var r=t.originalEvent,i=r.changedTouches[0],s=e.input.touchLocation(i);s.x<n.zone&&(n.joypadTouch=i.identifier,n.centerX=s.x,n.centerY=s.y,n.x=null,n.y=null)}},this.joypadMove=function(t){if(n.joypadTouch!==null){var r=t;for(var i=0,s=r.changedTouches.length;i<s;i++){var o=r.changedTouches[i];if(o.identifier===n.joypadTouch){var u=e.input.touchLocation(o),a=u.x-n.centerX,f=u.y-n.centerY,l=Math.sqrt(a*a+f*f),c=Math.max(1,l/n.size),h=Math.atan2(a,f);c>1&&(a/=c,f/=c,l/=c);var p=[f<-n.trigger,a>n.trigger,f>n.trigger,a<-n.trigger];for(var d=0;d<p.length;d++){var v=n.inputs[d];p[d]?(e.inputs[v]=!0,n.triggers[d]||e.input.trigger(v)):(e.inputs[v]=!1,n.triggers[d]&&e.input.trigger(v+"Up"))}e._extend(n,{dx:a,dy:f,x:n.centerX+a,y:n.centerY+f,dist:l,ang:h,triggers:p});break}}}t.preventDefault()},this.joypadEnd=function(t){var r=t;if(n.joypadTouch!==null)for(var i=0,s=r.changedTouches.length;i<s;i++){var o=r.changedTouches[i];if(o.identifier===n.joypadTouch){for(var u=0;u<n.triggers.length;u++){var a=n.inputs[u];e.inputs[a]=!1}n.joypadTouch=null;break}}t.preventDefault()},e.el.addEventListener("touchstart",this.joypadStart),e.el.addEventListener("touchmove",this.joypadMove),e.el.addEventListener("touchend",this.joypadEnd),e.el.addEventListener("touchcancel",this.joypadEnd),this.joypadEnabled=!0},mouseControls:function(t){t=t||{};var n=t.stageNum||0,r=t.mouseX||"mouseX",i=t.mouseY||"mouseY",s={};e.el.style.cursor="none",e.inputs[r]=0,e.inputs[i]=0,e._mouseMove=function(t){t.preventDefault();var o=t.touches?t.touches[0]:t,u=e.el,a=o.offsetX,f=o.offsetY,l,c,h=e.stage(n);if(e._isUndefined(a)||e._isUndefined(f))a=o.layerX,f=o.layerY;if(e._isUndefined(a)||e._isUndefined(f))e.input.offsetX===void 0&&e.input._containerOffset(),a=o.pageX-e.input.offsetX,f=o.pageY-e.input.offsetY;h&&(s.x=e.canvasToStageX(a,h),s.y=e.canvasToStageY(f,h),e.inputs[r]=s.x,e.inputs[i]=s.y,e.input.trigger("mouseMove",s))},e.el.addEventListener("mousemove",e._mouseMove,!0),e.el.addEventListener("touchstart",e._mouseMove,!0),e.el.addEventListener("touchmove",e._mouseMove,!0)},disableMouseControls:function(){e._mouseMove&&(e.el.removeEventListener("mousemove",e._mouseMove),e.el.style.cursor="inherit",e._mouseMove=null)},drawButtons:function(){var t=e.input.keypad,n=e.ctx;n.save(),n.textAlign="center",n.textBaseline="middle";for(var r=0;r<t.controls.length;r++){var i=t.controls[r];if(i[0]){n.font="bold "+t.size/2+"px arial";var s=r*t.unit+t.gutter,o=t.bottom-t.unit,u=e.inputs[i[0]];n.fillStyle=t.color||"#FFFFFF",n.globalAlpha=u?1:.5,n.fillRect(s,o,t.size,t.size),n.fillStyle=t.text||"#000000",n.fillText(i[1],s+t.size/2,o+t.size/2)}}n.restore()},drawCircle:function(t,n,r,i){var s=e.ctx,o=e.joypad;s.save(),s.beginPath(),s.globalAlpha=o.alpha,s.fillStyle=r,s.arc(t,n,i,0,Math.PI*2,!0),s.closePath(),s.fill(),s.restore()},drawJoypad:function(){var t=e.joypad;t.joypadTouch!==null&&(e.input.drawCircle(t.centerX,t.centerY,t.background,t.size),t.x!==null&&e.input.drawCircle(t.x,t.y,t.color,t.center))},drawCanvas:function(){this.touchEnabled&&this.drawButtons(),this.joypadEnabled&&this.drawJoypad()}}),e.input=new e.InputSystem,e.controls=function(t){return e.input.keyboardControls(),t?(e.input.touchControls({controls:[[],[],[],["action","b"],["fire","a"]]}),e.input.joypadControls()):e.input.touchControls(),e},e.component("platformerControls",{defaults:{speed:200,jumpSpeed:-300},added:function(){var t=this.entity.p;e._defaults(t,this.defaults),this.entity.on("step",this,"step"),this.entity.on("bump.bottom",this,"landed"),t.landed=0,t.direction="right"},landed:function(e){var t=this.entity.p;t.landed=.2},step:function(t){var n=this.entity.p;e.inputs.left?(n.vx=-n.speed,n.direction="left"):e.inputs.right?(n.direction="right",n.vx=n.speed):n.vx=0,n.landed>0&&(e.inputs.up||e.inputs.action)&&(n.vy=n.jumpSpeed,n.landed=-t),n.landed-=t}}),e.component("stepControls",{added:function(){var e=this.entity.p;e.stepDistance||(e.stepDistance=32),e.stepDelay||(e.stepDelay=.2),e.stepWait=0,this.entity.on("step",this,"step"),this.entity.on("hit",this,"collision")},collision:function(e){var t=this.entity.p;t.stepping&&(t.stepping=!1,t.x=t.origX,t.y=t.origY)},step:function(t){var n=this.entity.p,r=!1;n.stepWait-=t,n.stepping&&(n.x+=n.diffX*t/n.stepDelay,n.y+=n.diffY*t/n.stepDelay);if(n.stepWait>0)return;n.stepping&&(n.x=n.destX,n.y=n.destY),n.stepping=!1,n.diffX=0,n.diffY=0,e.inputs.left?n.diffX=-n.stepDistance:e.inputs.right&&(n.diffX=n.stepDistance),e.inputs.up?n.diffY=-n.stepDistance:e.inputs.down&&(n.diffY=n.stepDistance);if(n.diffY||n.diffX)n.stepping=!0,n.origX=n.x,n.origY=n.y,n.destX=n.x+n.diffX,n.destY=n.y+n.diffY,n.stepWait=n.stepDelay}})},Quintus.Touch=function(e){if(e._isUndefined(Quintus.Sprites))throw"Quintus.Touch requires Quintus.Sprites Module";var t="ontouchstart"in window,n=[0],r=0;e.Evented.extend("TouchSystem",{init:function(){var t=this;this.boundTouch=function(e){t.touch(e)},this.boundDrag=function(e){t.drag(e)},this.boundEnd=function(e){t.touchEnd(e)},e.el.addEventListener("touchstart",this.boundTouch),e.el.addEventListener("mousedown",this.boundTouch),e.el.addEventListener("touchmove",this.boundDrag),e.el.addEventListener("mousemove",this.boundDrag),e.el.addEventListener("touchend",this.boundEnd),e.el.addEventListener("mouseup",this.boundEnd),e.el.addEventListener("touchcancel",this.boundEnd),this.touchPos=new e.Evented,this.touchPos.grid={},this.touchPos.p={w:1,h:1,cx:0,cy:0},this.activeTouches={},this.touchedObjects={}},destroy:function(){e.el.removeEventListener("touchstart",this.boundTouch),e.el.removeEventListener("mousedown",this.boundTouch),e.el.removeEventListener("touchmove",this.boundDrag),e.el.removeEventListener("mousemove",this.boundDrag),e.el.removeEventListener("touchend",this.boundEnd),e.el.removeEventListener("mouseup",this.boundEnd),e.el.removeEventListener("touchcancel",this.boundEnd)},normalizeTouch:function(t,n){var r=t.offsetX,i=t.offsetY;if(e._isUndefined(r)||e._isUndefined(i))r=t.layerX,i=t.layerY;if(e._isUndefined(r)||e._isUndefined(i)){if(e.touch.offsetX===void 0){e.touch.offsetX=0,e.touch.offsetY=0;var s=e.el;do e.touch.offsetX+=s.offsetLeft,e.touch.offsetY+=s.offsetTop;while(s=s.offsetParent)}r=t.pageX-e.touch.offsetX,i=t.pageY-e.touch.offsetY}return this.touchPos.p.ox=this.touchPos.p.px=r/e.cssWidth*e.width,this.touchPos.p.oy=this.touchPos.p.py=i/e.cssHeight*e.height,n.viewport&&(this.touchPos.p.px/=n.viewport.scale,this.touchPos.p.py/=n.viewport.scale,this.touchPos.p.px+=n.viewport.x,this.touchPos.p.py+=n.viewport.y),this.touchPos.p.x=this.touchPos.p.px,this.touchPos.p.y=this.touchPos.p.py,this.touchPos.obj=null,this.touchPos},touch:function(t){var i=t.changedTouches||[t];for(var s=0;s<i.length;s++)for(var o=0;o<n.length;o++){var u=i[s],a=e.stage(n[o]);if(!a)continue;u.identifier=u.identifier||0;var f=this.normalizeTouch(u,a);a.regrid(f,!0);var l=a.search(f,r),c;if(l||o===n.length-1)c=l&&l.obj,f.obj=c,this.trigger("touch",f);if(c&&!this.touchedObjects[c]){this.activeTouches[u.identifier]={x:f.p.px,y:f.p.py,origX:c.p.x,origY:c.p.y,sx:f.p.ox,sy:f.p.oy,identifier:u.identifier,obj:c,stage:a},this.touchedObjects[c.p.id]=!0,c.trigger("touch",this.activeTouches[u.identifier]);break}}},drag:function(e){var t=e.changedTouches||[e];for(var n=0;n<t.length;n++){var r=t[n];r.identifier=r.identifier||0;var i=this.activeTouches[r.identifier],s=i&&i.stage;if(i){var o=this.normalizeTouch(r,s);i.x=o.p.px,i.y=o.p.py,i.dx=o.p.ox-i.sx,i.dy=o.p.oy-i.sy,i.obj.trigger("drag",i)}}e.preventDefault()},touchEnd:function(e){var t=e.changedTouches||[e];for(var n=0;n<t.length;n++){var r=t[n];r.identifier=r.identifier||0;var i=this.activeTouches[r.identifier];i&&(i.obj.trigger("touchEnd",i),delete this.touchedObjects[i.obj.p.id],this.activeTouches[r.identifier]=null)}e.preventDefault()}}),e.touch=function(t,i){return e.untouch(),r=t||e.SPRITE_UI,n=i||[2,1,0],e._isArray(n)||(n=[n]),e._touch||(e.touchInput=new e.TouchSystem),e},e.untouch=function(){return e.touchInput&&(e.touchInput.destroy(),delete e.touchInput),e}},Quintus.Sprites=function(e){return e.Class.extend("SpriteSheet",{init:function(t,n,r){if(!e.asset(n))throw"Invalid Asset:"+n;e._extend(this,{name:t,asset:n,w:e.asset(n).width,h:e.asset(n).height,tilew:64,tileh:64,sx:0,sy:0}),r&&e._extend(this,r),this.cols=this.cols||Math.floor(this.w/this.tilew)},fx:function(e){return Math.floor(e%this.cols*this.tilew+this.sx)},fy:function(e){return Math.floor(Math.floor(e/this.cols)*this.tileh+this.sy)},draw:function(t,n,r,i){t||(t=e.ctx),t.drawImage(e.asset(this.asset),this.fx(i),this.fy(i),this.tilew,this.tileh,Math.floor(n),Math.floor(r),this.tilew,this.tileh)}}),e.sheets={},e.sheet=function(t,n,r){if(!n)return e.sheets[t];e.sheets[t]=new e.SpriteSheet(t,n,r)},e.compileSheets=function(t,n){var r=e.asset(n);e._each(r,function(n,r){e.sheet(r,t,n)})},e.SPRITE_NONE=0,e.SPRITE_DEFAULT=1,e.SPRITE_PARTICLE=2,e.SPRITE_ACTIVE=4,e.SPRITE_FRIENDLY=8,e.SPRITE_ENEMY=16,e.SPRITE_POWERUP=32,e.SPRITE_UI=64,e.SPRITE_ALL=65535,e._generatePoints=function(e,t){if(e.p.points&&!t)return;var n=e.p,r=n.w/2,i=n.h/2;n.points=[[-r,-i],[r,-i],[r,i],[-r,i]]},e._generateCollisionPoints=function(t){if(!t.matrix&&!t.refreshMatrix)return;t.c||(t.c={points:[]});var n=t.p,r=t.c;if(!n.moved&&r.origX===n.x&&r.origY===n.y&&r.origScale===n.scale&&r.origScale===n.angle)return;r.origX=n.x,r.origY=n.y,r.origScale=n.scale,r.origAngle=n.angle,t.refreshMatrix();var i=t.container||e._nullContainer;r.x=i.matrix.transformX(n.x,n.y),r.y=i.matrix.transformY(n.x,n.y),r.angle=n.angle+i.c.angle,r.scale=(i.c.scale||1)*(n.scale||1);var s=Infinity,o=Infinity,u=-Infinity,a=-Infinity;for(var f=0;f<t.p.points.length;f++){t.c.points[f]||(t.c.points[f]=[]),t.matrix.transformArr(t.p.points[f],t.c.points[f]);var l=t.c.points[f][0],c=t.c.points[f][1];l<s&&(s=l),l>u&&(u=l),c<o&&(o=c),c>a&&(a=c)}s===u&&(u+=1),o===a&&(a+=1),r.cx=r.x-s,r.cy=r.y-o,r.w=u-s,r.h=a-o},e.GameObject.extend("Sprite",{init:function(t,n){this.p=e._extend({x:0,y:0,z:0,angle:0,frame:0,type:e.SPRITE_DEFAULT|e.SPRITE_ACTIVE},n),this.matrix=new e.Matrix2D,this.children=[],e._extend(this.p,t),this.size(),this.p.id=this.p.id||e._uniqueId(),this.c={points:[]},this.refreshMatrix()},size:function(e){if(e||!this.p.w||!this.p.h)this.asset()?(this.p.w=this.asset().width,this.p.h=this.asset().height):this.sheet()&&(this.p.w=this.sheet().tilew,this.p.h=this.sheet().tileh);this.p.cx=e||this.p.cx===void 0?this.p.w/2:this.p.cx,this.p.cy=e||this.p.cy===void 0?this.p.h/2:this.p.cy},asset:function(t,n){if(!t)return e.asset(this.p.asset);this.p.asset=t,n&&(this.size(!0),e._generatePoints(this,!0))},sheet:function(t,n){if(!t)return e.sheet(this.p.sheet);this.p.sheet=t,n&&(this.size(!0),e._generatePoints(this,!0))},hide:function(){this.p.hidden=!0},show:function(){this.p.hidden=!1},set:function(t){return e._extend(this.p,t),this},render:function(t){var n=this.p;if(n.hidden)return;t||(t=e.ctx),this.trigger("predraw",t),t.save(),this.p.opacity!==void 0&&this.p.opacity!==1&&(t.globalAlpha=this.p.opacity),this.matrix.setContextTransform(t),this.trigger("beforedraw",t),this.draw(t),this.trigger("draw",t),t.restore(),e._invoke(this.children,"render",t),this.trigger("postdraw",t),e.debug&&this.debugRender(t)},center:function(){this.container?(this.p.x=this.container.p.w/2,this.p.y=this.container.p.h/2):(this.p.x=e.width/2,this.p.y=e.height/2)},draw:function(t){var n=this.p;n.sheet?this.sheet().draw(t,-n.cx,-n.cy,n.frame):n.asset&&t.drawImage(e.asset(n.asset),-n.cx,-n.cy)},debugRender:function(t){this.p.points||e._generatePoints(this),t.save(),this.matrix.setContextTransform(t),t.beginPath(),t.fillStyle=this.p.hit?"blue":"red",t.strokeStyle="#FF0000",t.fillStyle="rgba(0,0,0,0.5)",t.moveTo(this.p.points[0][0],this.p.points[0][1]);for(var n=0;n<this.p.points.length;n++)t.lineTo(this.p.points[n][0],this.p.points[n][1]);t.lineTo(this.p.points[0][0],this.p.points[0][1]),t.stroke(),e.debugFill&&t.fill(),t.restore();if(this.c){var r=this.c;t.save(),t.globalAlpha=1,t.lineWidth=2,t.strokeStyle="#FF00FF",t.beginPath(),t.moveTo(r.x-r.cx,r.y-r.cy),t.lineTo(r.x-r.cx+r.w,r.y-r.cy),t.lineTo(r.x-r.cx+r.w,r.y-r.cy+r.h),t.lineTo(r.x-r.cx,r.y-r.cy+r.h),t.lineTo(r.x-r.cx,r.y-r.cy),t.stroke(),t.restore()}},update:function(e){this.trigger("prestep",e),this.step&&this.step(e),this.trigger("step",e),this.refreshMatrix(),this.stage&&this.children.length>0&&this.stage.updateSprites(this.children,e,!0)},refreshMatrix:function(){var e=this.p;this.matrix.identity(),this.container&&this.matrix.multiply(this.container.matrix),this.matrix.translate(e.x,e.y),e.scale&&this.matrix.scale(e.scale,e.scale),this.matrix.rotateDeg(e.angle)}}),e.Sprite.extend("MovingSprite",{init:function(t,n){this._super(e._extend({vx:0,vy:0,ax:0,ay:0},t),n)},step:function(e){var t=this.p;t.vx+=t.ax*e,t.vy+=t.ay*e,t.x+=t.vx*e,t.y+=t.vy*e}}),e},Quintus.Scenes=function(e){e.scenes={},e.stages=[],e.Scene=e.Class.extend({init:function(e,t){this.opts=t||{},this.sceneFunc=e}}),e.scene=function(t,n,r){return n===void 0?e.scenes[t]:(e._isFunction(n)&&(n=new e.Scene(n,r)),e.scenes[t]=n,n)},e._nullContainer={c:{x:0,y:0,cx:0,cy:0,angle:0,scale:1},matrix:e.matrix2d()},e.collision=function(){function o(e,r){var i=e[r],s=e[r+1]||e[0];t=-(s[1]-i[1]),n=s[0]-i[0];var o=Math.sqrt(t*t+n*n);o>0&&(t/=o,n/=o)}function u(e){return t*e[0]+n*e[1]}function a(e,a,f){var l,c,h,p,d,v,m,g,y,b,w,E,S=Number.POSITIVE_INFINITY,x=!1,T,N,C=f?s:i;r[0]=0,r[1]=0,e.c?T=e.c.points:(T=e.p.points,r[0]+=e.p.x,r[1]+=e.p.y),a.c?N=a.c.points:(N=a.p.points,r[0]+=-a.p.x,r[1]+=-a.p.y),e=e.p,a=a.p;for(y=0;y<T.length;y++){o(T,y),l=u(T[0]),c=l;for(b=1;b<T.length;b++)g=u(T[b]),g<l&&(l=g),g>c&&(c=g);h=u(N[0]),p=h;for(b=1;b<N.length;b++)g=u(N[b]),g<h&&(h=g),g>p&&(p=g);m=u(r),l+=m,c+=m,d=l-p,v=h-c;if(d>0||v>0)return null;w=(p-l)*-1,f&&(w*=-1),E=Math.abs(w),E<S&&(C.distance=w,C.magnitude=E,C.normalX=t,C.normalY=n,C.distance>0&&(C.distance*=-1,C.normalX*=-1,C.normalY*=-1),x=!0,S=E)}return x?C:null}function f(t,n){var r,i,s;return t.p.points||e._generatePoints(t),n.p.points||e._generatePoints(n),e._generateCollisionPoints(t),e._generateCollisionPoints(n),r=a(t,n),r?(i=a(n,t,!0),i?(s=i.magnitude<r.magnitude?i:r,s.magnitude===0?!1:(s.separate[0]=s.distance*s.normalX,s.separate[1]=s.distance*s.normalY,s)):!1):!1}var t,n,r=[0,0],i={separate:[]},s={separate:[]};return f}(),e.overlap=function(e,t){var n=e.c||e.p,r=t.c||t.p,i=n.x-n.cx,s=n.y-n.cy,o=r.x-r.cx,u=r.y-r.cy;return!(s+n.h<u||s>u+r.h||i+n.w<o||i>o+r.w)},e.Stage=e.GameObject.extend({defaults:{sort:!1,gridW:400,gridH:400},init:function(t,n){this.scene=t,this.items=[],this.lists={},this.index={},this.removeList=[],this.grid={},this.options=e._extend({},this.defaults),this.scene&&e._extend(this.options,t.opts),n&&e._extend(this.options,n),this.options.sort&&!e._isFunction(this.options.sort)&&(this.options.sort=function(e,t){return(e.p&&e.p.z||-1)-(t.p&&t.p.z||-1)})},destroyed:function(){this.invoke("debind"),this.trigger("destroyed")},loadScene:function(){this.scene&&this.scene.sceneFunc(this)},each:function(e){for(var t=0,n=this.items.length;t<n;t++)e.call(this.items[t],arguments[1],arguments[2])},invoke:function(e){for(var t=0,n=this.items.length;t<n;t++)this.items[t][e].call(this.items[t],arguments[1],arguments[2])},detect:function(e){for(var t=this.items.length-1;t>=0;t--)if(e.call(this.items[t],arguments[1],arguments[2],arguments[3]))return this.items[t];return!1},identify:function(e){var t;for(var n=this.items.length-1;n>=0;n--)if(t=e.call(this.items[n],arguments[1],arguments[2],arguments[3]))return t;return!1},addToLists:function(e,t){for(var n=0;n<e.length;n++)this.addToList(e[n],t)},addToList:function(e,t){this.lists[e]||(this.lists[e]=[]),this.lists[e].push(t)},removeFromLists:function(e,t){for(var n=0;n<e.length;n++)this.removeFromList(e[n],t)},removeFromList:function(e,t){var n=this.lists[e].indexOf(t);n!==-1&&this.lists[e].splice(n,1)},insert:function(t,n){return this.items.push(t),t.stage=this,t.container=n,n&&n.children.push(t),t.grid={},e._generatePoints(t),e._generateCollisionPoints(t),t.className&&this.addToList(t.className,t),t.activeComponents&&this.addToLists(t.activeComponents,t),t.p&&(this.index[t.p.id]=t),this.trigger("inserted",t),t.trigger("inserted",this),this.regrid(t),t},remove:function(e){this.delGrid(e),this.removeList.push(e)},forceRemove:function(e){var t=this.items.indexOf(e);if(t!==-1){this.items.splice(t,1),e.className&&this.removeFromList(e.className,e),e.activeComponents&&this.removeFromLists(e.activeComponents,e);if(e.container){var n=e.container.children.indexOf(e);n!==-1&&e.container.children.splice(n,1)}e.destroy&&e.destroy(),e.p.id&&delete this.index[e.p.id],this.trigger("removed",e)}},pause:function(){this.paused=!0},unpause:function(){this.paused=!1},_gridCellCheck:function(t,n,r,i){if(!i||i&t){var s=this.index[n];if(s&&s!==r&&e.overlap(r,s)){var o=e.collision(r,s);return o?(o.obj=s,o):!1}}},gridTest:function(t,n,r){var i=t.grid,s,o;for(var u=i.Y1;u<=i.Y2;u++)if(this.grid[u])for(var a=i.X1;a<=i.X2;a++){s=this.grid[u][a];if(s){o=e._detect(s,this._gridCellCheck,this,t,n);if(o)return o}}return!1},collisionLayer:function(e){this._collisionLayer=e,this.insert(e)},search:function(e,t){var n;t=t||e.p&&e.p.collisionMask;if(this._collisionLayer&&this._collisionLayer.p.type&t){n=this._collisionLayer.collide(e);if(n)return n}return n=this.gridTest(e,t,this._collisionLayer),n},_locateObj:{p:{x:0,y:0,w:1,h:1},grid:{}},locate:function(e,t,n){var r=null;return this._locateObj.p.x=e,this._locateObj.p.y=t,this.regrid(this._locateObj,!0),this._collisionLayer&&this._collisionLayer.p.type&n&&(r=this._collisionLayer.collide(this._locateObj)),r||(r=this.gridTest(this._locateObj,n,this._collisionLayer)),r&&r.obj?r.obj:!1},collide:function(e,t){var n,r,i=3;t=t||e.p&&e.p.collisionMask,this.regrid(e);if(this._collisionLayer&&this._collisionLayer.p.type&t)while(i>0&&(n=this._collisionLayer.collide(e)))n.obj=this._collisionLayer,e.trigger("hit",n),e.trigger("hit.collision",n),this.regrid(e),i--;r=this.gridTest(e,t,this._collisionLayer);if(r){e.trigger("hit",r),e.trigger("hit.sprite",r);var s=r.obj;r.obj=e,r.normalX*=-1,r.normalY*=-1,r.distance=0,r.magnitude=0,r.separate[0]=0,r.separate[1]=0,s.trigger("hit",r),s.trigger("hit.sprite",r),this.regrid(e)}return r||n},delGrid:function(e){var t=e.grid;for(var n=t.Y1;n<=t.Y2;n++)if(this.grid[n])for(var r=t.X1;r<=t.X2;r++)this.grid[n][r]&&delete this.grid[n][r][e.p.id]},addGrid:function(e){var t=e.grid;for(var n=t.Y1;n<=t.Y2;n++){this.grid[n]||(this.grid[n]={});for(var r=t.X1;r<=t.X2;r++)this.grid[n][r]||(this.grid[n][r]={}),this.grid[n][r][e.p.id]=e.p.type}},regrid:function(e,t){if(this._collisionLayer&&e===this._collisionLayer)return;if(!e.p.type&&!t)return;var n=e.c||e.p,r=Math.floor(n.x/this.options.gridW),i=Math.floor(n.y/this.options.gridH),s=Math.floor((n.x+n.w)/this.options.gridW),o=Math.floor((n.y+n.h)/this.options.gridH),u=e.grid;if(u.X1!==r||u.X2!==s||u.Y1!==i||u.Y2!==o)u.X1!==void 0&&this.delGrid(e),u.X1=r,u.X2=s,u.Y1=i,u.Y2=o,t||this.addGrid(e)},updateSprites:function(t,n,r){var i;for(var s=0,o=t.length;s<o;s++){i=t[s];if(r||!i.container)i.update(n),e._generateCollisionPoints(i),this.regrid(i)}},step:function(e){if(this.paused)return!1;this.trigger("prestep",e),this.updateSprites(this.items,e),this.trigger("step",e);if(this.removeList.length>0){for(var t=0,n=this.removeList.length;t<n;t++)this.forceRemove(this.removeList[t]);this.removeList.length=0}this.trigger("poststep",e)},render:function(e){this.options.sort&&this.items.sort(this.options.sort),this.trigger("prerender",e),this.trigger("beforerender",e);for(var t=0,n=this.items.length;t<n;t++){var r=this.items[t];r.container||r.render(e)}this.trigger("render",e),this.trigger("postrender",e)}}),e.activeStage=0,e.StageSelector=e.Class.extend({emptyList:[],init:function(e,t){this.stage=e,this.selector=t,this.items=this.stage.lists[this.selector]||this.emptyList,this.length=this.items.length},each:function(e){for(var t=0,n=this.items.length;t<n;t++)e.call(this.items[t],arguments[1],arguments[2]);return this},invoke:function(e){for(var t=0,n=this.items.length;t<n;t++)this.items[t][e].call(this.items[t],arguments[1],arguments[2]);return this},trigger:function(e,t){this.invoke("trigger",e,t)},destroy:function(){this.invoke("destroy")},detect:function(e){for(var t=0,n=null,r=this.items.length;t<r;t++)if(e.call(this.items[t],arguments[1],arguments[2]))return this.items[t];return!1},identify:function(e){var t=null;for(var n=0,r=null,i=this.items.length;n<i;n++)if(t=e.call(this.items[n],arguments[1],arguments[2]))return t;return!1},_pObject:function(t){e._extend(this.p,t)},_pSingle:function(e,t){this.p[e]=t},set:function(e,t){return t===void 0?this.each(this._pObject,e):this.each(this._pSingle,e,t),this},at:function(e){return this.items[e]},first:function(){return this.items[0]},last:function(){return this.items[this.items.length-1]}}),e.select=function(t,n){return n=n===void 0?e.activeStage:n,n=e.stage(n),e._isNumber(t)?n.index[t]:new e.StageSelector(n,t)},e.stage=function(t){return t=t===void 0?e.activeStage:t,e.stages[t]},e.stageScene=function(t,n,r){e._isString(t)&&(t=e.scene(t)),e._isObject(n)&&(r=n,n=e._popProperty(r,"stage")||t&&t.opts.stage||0),r=e._clone(r);var i=e._popProperty(r,"stageClass")||t&&t.opts.stageClass||e.Stage;return n=e._isUndefined(n)?t&&t.opts.stage||0:n,e.stages[n]&&e.stages[n].destroy(),e.activeStage=n,e.stages[n]=new i(t,r),t&&e.stages[n].loadScene(),e.activeStage=0,e.loop||e.gameLoop(e.stageGameLoop),e.stages[n]},e.stageGameLoop=function(t){e.ctx&&e.clear(),t<0&&(t=1/60),t>1/15&&(t=1/15);for(var n=0,r=e.stages.length;n<r;n++){e.activeStage=n;var i=e.stage();i&&(i.step(t),i.render(e.ctx))}e.activeStage=0,e.input&&e.ctx&&e.input.drawCanvas(e.ctx)},e.clearStage=function(t){e.stages[t]&&(e.stages[t].destroy(),e.stages[t]=null)},e.clearStages=function(){for(var t=0,n=e.stages.length;t<n;t++)e.stages[t]&&e.stages[t].destroy();e.stages.length=0}},Quintus["2D"]=function(e){e.component("viewport",{added:function(){this.entity.on("prerender",this,"prerender"),this.entity.on("render",this,"postrender"),this.x=0,this.y=0,this.offsetX=0,this.offsetY=0,this.centerX=e.width/2,this.centerY=e.height/2,this.scale=1},extend:{follow:function(e,t){this.off("poststep",this.viewport,"follow"),this.viewport.directions=t||{x:!0,y:!0},this.viewport.following=e,this.on("poststep",this.viewport,"follow"),this.viewport.follow(!0)},unfollow:function(){this.off("poststep",this.viewport,"follow")},centerOn:function(e,t){this.viewport.centerOn(e,t)},moveTo:function(e,t){return this.viewport.moveTo(e,t)}},follow:function(t){var n=e._isFunction(this.directions.x)?this.directions.x(this.following):this.directions.x,r=e._isFunction(this.directions.y)?this.directions.y(this.following):this.directions.y;this[t===!0?"centerOn":"softCenterOn"](n?this.following.p.x+this.following.p.w/2-this.offsetX:undefined,r?this.following.p.y+this.following.p.h/2-this.offsetY:undefined)},offset:function(e,t){this.offsetX=e,this.offsetY=t},softCenterOn:function(t,n){t!==void 0&&(this.x+=(t-e.width/2/this.scale-this.x)/3),n!==void 0&&(this.y+=(n-e.height/2/this.scale-this.y)/3)},centerOn:function(t,n){t!==void 0&&(this.x=t-e.width/2/this.scale),n!==void 0&&(this.y=n-e.height/2/this.scale)},moveTo:function(e,t){return e!==void 0&&(this.x=e),t!==void 0&&(this.y=t),this.entity},prerender:function(){this.centerX=this.x+e.width/2/this.scale,this.centerY=this.y+e.height/2/this.scale,e.ctx.save(),e.ctx.translate(Math.floor(e.width/2),Math.floor(e.height/2)),e.ctx.scale(this.scale,this.scale),e.ctx.translate(-Math.floor(this.centerX),-Math.floor(this.centerY))},postrender:function(){e.ctx.restore()}}),e.TileLayer=e.Sprite.extend({init:function(e){this._super(e,{tileW:32,tileH:32,blockTileW:10,blockTileH:10,type:1}),this.p.dataAsset&&this.load(this.p.dataAsset),this.blocks=[],this.p.blockW=this.p.tileW*this.p.blockTileW,this.p.blockH=this.p.tileH*this.p.blockTileH,this.colBounds={},this.directions=["top","left","right","bottom"],this.collisionObject={p:{w:this.p.tileW,h:this.p.tileH,cx:this.p.tileW/2,cy:this.p.tileH/2}},this.collisionNormal={separate:[]}},load:function(t){var n=e._isString(t)?e.asset(t):t;this.p.tiles=n,this.p.rows=n.length,this.p.cols=n[0].length,this.p.w=this.p.rows*this.p.tileH,this.p.h=this.p.cols*this.p.tileW},getTile:function(e,t){return this.p.tiles[t]&&this.p.tiles[t][e]},setTile:function(e,t,n){var r=this.p,i=Math.floor(e/r.blockTileW),s=Math.floor(t/r.blockTileH);i>=0&&s>=0&&i<this.p.cols&&s<this.p.cols&&(this.p.tiles[t][e]=n,this.blocks[s]&&(this.blocks[s][i]=null))},tilePresent:function(e,t){return this.p.tiles[t]&&this.collidableTile(this.p.tiles[t][e])},drawableTile:function(e){return e>0},collidableTile:function(e){return e>0},collide:function(t){var n=this.p,r=Math.floor((t.p.x-t.p.cx-n.x)/n.tileW),i=Math.floor((t.p.y-t.p.cy-n.y)/n.tileH),s=Math.floor((t.p.x-t.p.cx+t.p.w-n.x)/n.tileW),o=Math.floor((t.p.y-t.p.cy+t.p.h-n.y)/n.tileH),u=this.collisionObject,a=this.collisionNormal,f;a.collided=!1;for(var l=i;l<=o;l++)for(var c=r;c<=s;c++)this.tilePresent(c,l)&&(u.p.x=c*n.tileW+n.x+n.tileW/2,u.p.y=l*n.tileH+n.y+n.tileH/2,f=e.collision(t,u),f&&f.magnitude>0&&(!a.collided||a.magnitude<f.magnitude)&&(a.collided=!0,a.separate[0]=f.separate[0],a.separate[1]=f.separate[1],a.magnitude=f.magnitude,a.distance=f.distance,a.normalX=f.normalX,a.normalY=f.normalY,a.tileX=c,a.tileY=l,a.tile=this.getTile(c,l)));return a.collided?a:!1},prerenderBlock:function(e,t){var n=this.p,r=n.tiles,i=this.sheet(),s=e*n.blockTileW,o=t*n.blockTileH;if(s<0||s>=this.p.cols||o<0||o>=this.p.rows)return;var u=document.createElement("canvas"),a=u.getContext("2d");u.width=n.blockW,u.height=n.blockH,this.blocks[t]=this.blocks[t]||{},this.blocks[t][e]=u;for(var f=0;f<n.blockTileH;f++)if(r[f+o])for(var l=0;l<n.blockTileW;l++)this.drawableTile(r[f+o][l+s])&&i.draw(a,l*n.tileW,f*n.tileH,r[f+o][l+s])},drawBlock:function(e,t,n){var r=this.p,i=Math.floor(t*r.blockW+r.x),s=Math.floor(n*r.blockH+r.y);(!this.blocks[n]||!this.blocks[n][t])&&this.prerenderBlock(t,n),this.blocks[n]&&this.blocks[n][t]&&e.drawImage(this.blocks[n][t],i,s)},draw:function(t){var n=this.p,r=this.stage.viewport,i=r?r.scale:1,s=r?r.x:0,o=r?r.y:0,u=e.width/i,a=e.height/i,f=Math.floor((s-n.x)/n.blockW),l=Math.floor((o-n.y)/n.blockH),c=Math.floor((s+u-n.x)/n.blockW),h=Math.floor((o+a-n.y)/n.blockH);for(var p=l;p<=h;p++)for(var d=f;d<=c;d++)this.drawBlock(t,d,p)}}),e.gravityY=9.8*100,e.gravityX=0,e.dx=.05,e.component("2d",{added:function(){var t=this.entity;e._defaults(t.p,{vx:0,vy:0,ax:0,ay:0,gravity:1,collisionMask:e.SPRITE_DEFAULT}),t.on("step",this,"step"),t.on("hit",this,"collision")},collision:function(e,t){var n=this.entity,r=n.p,i=0;e.impact=0;var s=Math.abs(r.vx),o=Math.abs(r.vy);r.x-=e.separate[0],r.y-=e.separate[1],e.normalY<-0.3&&(r.vy>0&&(r.vy=0),e.impact=o,n.trigger("bump.bottom",e)),e.normalY>.3&&(r.vy<0&&(r.vy=0),e.impact=o,n.trigger("bump.top",e)),e.normalX<-0.3&&(r.vx>0&&(r.vx=0),e.impact=s,n.trigger("bump.right",e)),e.normalX>.3&&(r.vx<0&&(r.vx=0),e.impact=s,n.trigger("bump.left",e))},step:function(t){var n=this.entity.p,r=t;while(r>0)t=Math.min(1/30,r),n.vx+=n.ax*t+e.gravityX*t*n.gravity,n.vy+=n.ay*t+e.gravityY*t*n.gravity,n.x+=n.vx*t,n.y+=n.vy*t,this.entity.stage.collide(this.entity),r-=t}}),e.component("aiBounce",{added:function(){this.entity.on("bump.right",this,"goLeft"),this.entity.on("bump.left",this,"goRight")},goLeft:function(e){this.entity.p.vx=-e.impact},goRight:function(e){this.entity.p.vx=e.impact}})};